name: Auto Merge and Review

on:
  schedule:
    - cron: '0 * * * *' # Run every hour
  workflow_dispatch:

jobs:
  review-and-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

    steps:
      - name: Checkout Main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Simple CLI (Reviewer)
        run: |
          npm ci
          npm run build
          npm install -g .
          echo "Simple CLI installed version: $(simple --version || echo 'unknown')"

      - name: Process Open PRs
        run: |
          # Fetch all Open, Mergeable PRs
          # We use a unique delimiter to handle multiline output if necessary
          PRS=$(gh pr list --json number,mergeable,headRefName --state open --limit 10)
          
          echo "Found PRs: $PRS"

          # Use jq to iterate
          echo "$PRS" | jq -c '.[]' | while read -r pr; do
            PR_NUMBER=$(echo "$pr" | jq -r '.number')
            IS_MERGEABLE=$(echo "$pr" | jq -r '.mergeable')
            BRANCH_NAME=$(echo "$pr" | jq -r '.headRefName')

            echo "---------------------------------------------------"
            echo "Processing PR #$PR_NUMBER ($BRANCH_NAME)..."

            if [ "$IS_MERGEABLE" != "MERGEABLE" ]; then
              echo "PR #$PR_NUMBER is not mergeable (State: $IS_MERGEABLE). Skipping."
              continue
            fi

            # Checkout the PR
            echo "Checking out PR #$PR_NUMBER..."
            gh pr checkout $PR_NUMBER

            # Attempt to run the code/tests
            echo "Running validation..."
            if npm ci && npm test; then
              echo "✅ Verification Passed!"
              echo "Merging PR #$PR_NUMBER..."
              gh pr merge $PR_NUMBER --merge --auto
            else
              echo "❌ Verification Failed."
              
              # Capture the failure log
              # We re-run capturing output if the first run didn't separate it well, 
              # or just use the last exit code knowledge.
              # Let's run it again to capture output for the prompt specifically.
              OUTPUT=$(npm test 2>&1 | tail -n 50)
              
              echo "Asking Simple CLI to review and comment..."
              
              # Escape output for safe passing to the command line
              # We use a temporary file for the log to avoid command line length limits and escaping hell
              echo "$OUTPUT" > test_failure.log
              
              # We use the agent to analyze and comment
              # We rely on the 'pr_comment' tool available to the agent
              simple "You are a CI/CD assistant. The tests for PR #$PR_NUMBER failed. Read the log from 'test_failure.log'. specificially look for failures. Then, use the 'pr_comment' tool to post a helpful comment on PR #$PR_NUMBER explaining the failure and suggesting fixes. Do not try to fix the code yourself, just comment." --non-interactive
              
              echo "Review complete."
            fi

            # Clean up and switch back to main for the next iteration
            git clean -fd
            git checkout main
          done
